<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Pedidos (TESTES)</title>
    <link rel="icon" href="https://i.ibb.co/BHq1HsPG/2-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-enter, .toast-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .printable-area { background-color: white; }
        img.mockup-image:not([src]), img.mockup-image[src=""] { display: none; }
        img.mockup-image:error { content: url('https://placehold.co/400x400/e2e8f0/94a3b8?text=Arte+Indispon%C3%ADvel'); }
        input[type="file"]::file-selector-button { @apply bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 border-none mr-4 cursor-pointer; }
        .size-input-container { @apply flex flex-col items-center w-24; }
        .part-type-selector { @apply px-3 py-1 text-xs font-semibold rounded-md border-2 transition-colors duration-200; }
        .part-type-selector.active { @apply bg-blue-600 border-blue-600 text-white; }
        .part-type-selector:not(.active) { @apply bg-white border-gray-300 text-gray-600 hover:bg-gray-100; }
        .status-badge { @apply text-xs font-semibold py-1 px-2 rounded-full; }
        .status-Pendente { @apply bg-yellow-100 text-yellow-800; }
        .status-Confirmado { @apply bg-blue-100 text-blue-800; }
        .status-Em-Produção { @apply bg-purple-100 text-purple-800; }
        .status-Finalizado { @apply bg-green-100 text-green-800; }
        .status-Entregue { @apply bg-gray-200 text-gray-800; }
        .kanban-board { display: flex; overflow-x: auto; padding-bottom: 1rem; gap: 1.5rem; }
        .kanban-column { flex: 0 0 340px; max-width: 340px; }
        .html2pdf__page-break { page-break-before: always; }
    </style>
</head>
<body class="antialiased text-gray-800 bg-slate-50">

    <div id="authContainer" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-md">
            <form id="loginForm">
                <h2 class="text-2xl font-bold text-center">Login (Ambiente de Testes)</h2>
                <div class="mt-4 space-y-4">
                    <input type="email" id="loginEmail" placeholder="E-mail" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="loginPassword" placeholder="Senha" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 mt-6 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Entrar</button>
                 <div class="mt-4 text-center">
                    <a href="#" id="forgotPasswordBtn" class="text-sm text-blue-600 hover:underline">Esqueci minha senha</a>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
            <div class="w-full mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <img src="https://i.ibb.co/BHq1HsPG/2-removebg-preview.png" alt="Logo" class="h-8 w-auto mr-3">
                    <h1 class="text-xl font-bold text-gray-900">Gerenciador de Pedidos <span class="text-xs font-semibold bg-yellow-200 text-yellow-800 py-1 px-2 rounded-full align-middle">AMBIENTE DE TESTES</span></h1>
                </div>
                <div class="flex items-center gap-4">
                     <button id="priceTableBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-gray-300 transition duration-300 flex items-center justify-center" title="Tabela de Preços">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a1 1 0 011-1h5a1 1 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                          </svg>
                     </button>
                    <button id="addOrderBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Novo Pedido
                    </button>
                    <div class="relative" id="userMenuContainer">
                        <button id="userMenuBtn" class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-gray-800">
                            <span id="userEmail" class="hidden sm:inline"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="userDropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 hidden ring-1 ring-black ring-opacity-5">
                            <a href="#" id="financeDashboardBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Financeiro</a>
                            <div class="border-t border-gray-100"></div>
                            <a href="#" id="backupBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Fazer Backup</a>
                            <label for="restoreFile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Importar Backup</label>
                            <input type="file" id="restoreFile" class="hidden" accept=".json">
                            <a href="#" id="toggleViewBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver Entregues</a>
                             <div class="border-t border-gray-100"></div>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Sair</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="mainContent" class="w-full mx-auto p-4 sm:p-6 lg:px-8">
            <div id="ordersDashboard">
                <div id="ordersList">
                    <div id="loadingIndicator" class="text-center w-full text-gray-500 col-span-full">Carregando pedidos...</div>
                </div>
            </div>
            <div id="financeDashboard" class="hidden">
                <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Financeiro</h2>
                    <div class="flex items-center gap-4 flex-wrap">
                        <div id="customPeriodContainer" class="hidden flex items-center gap-2">
                            <input type="date" id="startDateInput" class="p-2 border rounded-md bg-white text-sm">
                            <span class="text-gray-500">até</span>
                            <input type="date" id="endDateInput" class="p-2 border rounded-md bg-white text-sm">
                        </div>
                        <select id="periodFilter" class="p-2 border rounded-md bg-white">
                            <option value="thisMonth">Este Mês</option>
                            <option value="lastMonth">Mês Passado</option>
                            <option value="thisYear">Este Ano</option>
                            <option value="custom">Período Personalizado</option>
                        </select>
                        <button id="copyReportBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 text-sm flex items-center gap-2" title="Copiar dados para colar em planilha">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a1 1 0 102 0V5h6a1 1 0 100-2H5z" /></svg>
                            Copiar Relatório
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-sm font-semibold text-green-800">FATURAMENTO BRUTO</h3><p id="faturamentoBruto" class="text-2xl font-bold text-green-900">R$ 0,00</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-sm font-semibold text-red-800">DESPESAS TOTAIS</h3><p id="despesasTotais" class="text-2xl font-bold text-red-900">R$ 0,00</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-sm font-semibold text-yellow-800">CONTAS A RECEBER</h3><p id="contasAReceber" class="text-2xl font-bold text-yellow-900">R$ 0,00</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-sm font-semibold text-blue-800">LUCRO LÍQUIDO</h3><p id="lucroLiquido" class="text-2xl font-bold text-blue-900">R$ 0,00</p></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-bold mb-4 text-red-800">Top 5 Despesas por Categoria</h3>
                        <div id="topExpensesByCategory">
                            <p class="text-sm text-gray-500">Nenhum dado no período.</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-bold mb-4 text-green-800">Top 5 Receitas por Categoria</h3>
                        <div id="topIncomesByCategory">
                            <p class="text-sm text-gray-500">Nenhum dado no período.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Lançamentos</h3>
                        <div class="flex gap-2">
                            <button id="addIncomeBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">+ Entrada</button>
                            <button id="addExpenseBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">- Despesa</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="transactionSearchInput" placeholder="Buscar por descrição..." class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-2 px-4">Data</th>
                                    <th class="py-2 px-4">Descrição</th>
                                    <th class="py-2 px-4">Categoria</th>
                                    <th class="py-2 px-4 text-right">Valor</th>
                                    <th class="py-2 px-4 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="priceTableModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 id="priceTableModalTitle" class="text-2xl font-bold text-gray-800">Tabela de Preços</h3>
            </div>
            <div id="priceTableContainer" class="p-6 overflow-y-auto">
                </div>
            <div id="priceTableFooter" class="p-4 bg-gray-50 border-t flex justify-end items-center gap-4">
                <div id="priceTableEditMessage" class="text-sm text-gray-600 mr-auto hidden">Clique em um campo para editar.</div>
                <button id="editPriceTableBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">Editar</button>
                <button id="addPriceItemBtn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 hidden">Adicionar Item</button>
                <button id="savePriceTableBtn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 hidden">Salvar Alterações</button>
                <button id="cancelPriceTableBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 hidden">Cancelar</button>
                <button id="closePriceTableBtn" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600">Fechar</button>
            </div>
        </div>
    </div>
    <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-y-auto">
            <form id="orderForm" class="p-8 space-y-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Novo Pedido</h2>
                <input type="hidden" id="orderId">
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-semibold px-2">1. Dados do Cliente e Datas</legend>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-2">
                        <input type="text" id="clientName" placeholder="Nome do Cliente" class="p-2 border rounded-md w-full col-span-1 sm:col-span-2 lg:col-span-2" required>
                        <input type="text" id="clientPhone" placeholder="Telefone" class="p-2 border rounded-md w-full">
                        <select id="orderStatus" class="p-2 border rounded-md w-full bg-white">
                            <option value="Pendente">Pendente</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Em Produção">Em Produção</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                        <div>
                            <label for="orderDate" class="text-xs">Data Pedido</label>
                            <input type="date" id="orderDate" class="p-2 border rounded-md w-full">
                        </div>
                        <div>
                            <label for="deliveryDate" class="text-xs">Data Entrega</label>
                            <input type="date" id="deliveryDate" class="p-2 border rounded-md w-full">
                        </div>
                    </div>
                </fieldset>
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-semibold px-2">2. Arquivos da Arte (Mockup)</legend>
                    <input type="file" id="mockupFiles" class="p-2 border rounded-md w-full mt-1 text-sm text-gray-500" accept="image/*" multiple>
                    <div id="existingFilesContainer" class="text-sm text-gray-600 mt-2 space-y-1"></div>
                </fieldset>
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-semibold px-2">3. Peças e Tamanhos</legend>
                    <div id="partsContainer" class="space-y-6"></div>
                    <button type="button" id="addPartBtn" class="mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Adicionar Peça (ex: Camisa, Calça)</button>
                </fieldset>
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-semibold px-2">4. Observação Geral</legend>
                    <textarea id="generalObservation" class="w-full p-2 border rounded-md mt-2" rows="3" placeholder="Detalhes gerais, acabamentos, etc."></textarea>
                </fieldset>
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-semibold px-2">5. Financeiro</legend>
                    <div id="financialsContainer" class="space-y-4 mb-4"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 border-t pt-4 items-end">
                        <div>
                            <label for="downPayment" class="text-xs font-semibold text-gray-600">Adiantamento (R$)</label>
                            <div class="flex items-center relative">
                                <span class="text-gray-500 absolute left-3">R$</span>
                                <input type="number" step="0.01" id="downPayment" class="p-2 border rounded-md w-full pl-10">
                            </div>
                        </div>
                        <div>
                            <label for="paymentMethod" class="text-xs font-semibold text-gray-600">Forma de Pagamento</label>
                            <input type="text" id="paymentMethod" class="p-2 border rounded-md w-full">
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Total do Pedido</p>
                            <p id="grandTotal" class="text-2xl font-bold text-blue-600">R$ 0,00</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg text-center">
                            <p class="text-sm text-red-700">Resta Pagar</p>
                            <p id="remainingTotal" class="text-2xl font-bold text-red-600">R$ 0,00</p>
                        </div>
                    </div>
                </fieldset>
                <div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 mt-8">
                    <div id="uploadIndicator" class="text-sm text-blue-600 font-semibold hidden">Salvando...</div>
                    <button type="button" id="cancelBtn" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600">Cancelar</button>
                    <button type="submit" id="saveBtn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Pedido</button>
                </div>
            </form>
        </div>
    </div>
    <div id="viewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter"></div>
    <div id="infoModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <p id="infoModalMessage" class="text-lg font-semibold text-center mb-4"></p>
            <div class="flex justify-center">
                <button id="infoModalCloseBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>
    <div id="idleModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[60] hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">Você ainda está aí?</h3>
            <p class="text-gray-600 mb-6">Por segurança, sua sessão será encerrada em <span id="countdownTimer" class="font-bold">60</span> segundos.</p>
            <button id="stayLoggedInBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Continuar Ativo</button>
        </div>
    </div>
    <div id="optionsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[60] hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <h3 id="optionsModalTitle" class="text-xl font-bold mb-4">Gerenciar Opções</h3>
            <div id="optionsList" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <div class="flex gap-2 items-center border-t pt-4">
                <input type="text" id="newOptionInput" class="flex-grow p-2 border rounded-md" placeholder="Adicionar nova opção">
                <button id="addOptionBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar</button>
            </div>
            <button id="closeOptionsModalBtn" class="mt-4 w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[70] hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="confirmModalMessage" class="text-gray-600 mb-6">Tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirmOkBtn" class="flex-1 bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>
    <div id="transactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <h3 id="transactionModalTitle" class="text-xl font-bold mb-4">Novo Lançamento</h3>
            <form id="transactionForm">
                <input type="hidden" id="transactionType">
                <input type="hidden" id="transactionId">
                <div class="space-y-4">
                    <div>
                        <label for="transactionDate" class="text-sm font-semibold">Data</label>
                        <input type="date" id="transactionDate" class="p-2 border rounded-md w-full" required>
                    </div>
                    <div>
                        <label for="transactionDescription" class="text-sm font-semibold">Descrição</label>
                        <input type="text" id="transactionDescription" class="p-2 border rounded-md w-full" required>
                    </div>
                    <div>
                        <label for="transactionCategory" class="text-sm font-semibold">Categoria</label>
                        <input type="text" id="transactionCategory" placeholder="Ex: Matéria-prima, Venda" class="p-2 border rounded-md w-full">
                    </div>
                    <div>
                        <label for="transactionAmount" class="text-sm font-semibold">Valor</label>
                        <div class="flex items-center relative">
                            <span class="text-gray-500 absolute left-3">R$</span>
                            <input type="number" step="0.01" id="transactionAmount" class="p-2 border rounded-md w-full pl-10" required>
                        </div>
                    </div>
                    <div id="transactionStatusContainer" class="hidden pt-2">
                        <label class="text-sm font-semibold">Status</label>
                        <div class="flex gap-x-6 mt-2">
                            <label class="flex items-center">
                                <input type="radio" name="transactionStatus" value="pago" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">Recebido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="transactionStatus" value="a_receber" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">A Receber</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelTransactionBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="saveTransactionBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <template id="partTemplate">
        <div class="part-item border p-4 rounded-md bg-gray-50 relative space-y-3">
            <button type="button" class="remove-part-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                <div class="relative col-span-1 md:col-span-2 flex items-center">
                    <input type="text" placeholder="Tipo da Peça (ex: Camisa Gola V)" class="p-2 border rounded-md w-full part-type" list="part-type-list">
                    <button type="button" class="manage-options-btn p-1 absolute right-1 bg-gray-200 rounded-md hover:bg-gray-300" data-type="partTypes">⚙️</button>
                </div>
                <div class="relative flex items-center">
                    <input type="text" placeholder="Material (ex: Dry-Fit)" class="p-2 border rounded-md w-full part-material" list="part-material-list">
                    <button type="button" class="manage-options-btn p-1 absolute right-1 bg-gray-200 rounded-md hover:bg-gray-300" data-type="materialTypes">⚙️</button>
                </div>
                <input type="text" placeholder="Cor Principal" class="p-2 border rounded-md w-full part-color-main">
            </div>
            <div class="flex items-center space-x-2 pt-2 border-t">
               <span class="text-sm font-semibold text-gray-600">Tipo de Entrada:</span>
               <button type="button" class="part-type-selector" data-type="comum">Comum</button>
               <button type="button" class="part-type-selector" data-type="detalhado">Detalhado</button>
            </div>
            <div class="part-content-container mt-2"></div>
        </div>
    </template>
    <template id="comumPartContentTemplate">
        <button type="button" class="toggle-sizes-btn mt-2 bg-blue-100 text-blue-800 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-blue-200">Tamanhos Padrão</button>
        <div class="sizes-grid hidden mt-3 space-y-4"></div>
        <div class="border-t mt-4 pt-3">
            <div class="specific-sizes-list space-y-2"></div>
            <button type="button" class="add-specific-size-btn mt-2 bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">+ Adicionar Tamanho Específico</button>
        </div>
    </template>
    <template id="specificSizeRowTemplate">
        <div class="specific-size-row grid grid-cols-12 gap-2 items-center">
            <div class="col-span-3"><input type="text" placeholder="Largura (cm)" class="p-1 border rounded-md w-full text-sm item-spec-width"></div>
            <div class="col-span-3"><input type="text" placeholder="Altura (cm)" class="p-1 border rounded-md w-full text-sm item-spec-height"></div>
            <div class="col-span-5"><input type="text" placeholder="Observações (ex: manga +5cm)" class="p-1 border rounded-md w-full text-sm item-spec-obs"></div>
            <div class="col-span-1 flex justify-center"><button type="button" class="remove-specific-row-btn text-red-500 font-bold">&times;</button></div>
        </div>
    </template>
    <template id="detalhadoPartContentTemplate">
        <div class="detailed-items-list space-y-2 mt-3">
            <div class="grid grid-cols-12 gap-2 font-semibold text-sm px-1">
                <div class="col-span-5">Nome</div>
                <div class="col-span-4">Tamanho</div>
                <div class="col-span-2">Número</div>
                <div class="col-span-1"></div>
            </div>
        </div>
        <button type="button" class="add-detailed-row-btn mt-2 bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">+ Adicionar Linha</button>
    </template>
    <template id="financialRowTemplate">
        <div class="financial-item grid grid-cols-4 gap-4 items-end">
            <div class="font-semibold financial-part-name col-span-1 self-center">
                <span>Peça 1</span>
                <span class="block text-xs font-normal text-gray-500 price-group-label"></span>
            </div>
            <div>
                <label class="text-xs font-semibold text-gray-600">Quantidade</label>
                <input type="number" class="p-2 border rounded-md w-full bg-gray-100 financial-quantity" readonly>
            </div>
            <div>
                <label class="text-xs font-semibold text-gray-600">Valor Unitário</label>
                <div class="flex items-center relative">
                    <span class="text-gray-500 absolute left-3">R$</span>
                    <input type="number" step="0.01" class="p-2 border rounded-md w-full financial-price pl-10">
                </div>
            </div>
            <div class="text-right">
                <label class="text-xs font-semibold text-gray-600">Subtotal</label>
                <p class="font-bold text-lg financial-subtotal">R$ 0,00</p>
            </div>
        </div>
    </template>

    <datalist id="part-type-list"></datalist>
    <datalist id="part-material-list"></datalist>

    <div id="backupReminderBanner" class="hidden fixed bottom-5 right-5 w-full max-w-sm bg-white rounded-lg shadow-lg p-4 border toast-enter z-50">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold text-gray-800">Lembrete de Backup</p>
                <p class="text-sm text-gray-600 mt-1">Seu último backup foi há mais de 7 dias. Mantenha seus dados seguros!</p>
                <div class="mt-3 flex gap-2">
                    <button id="backupNowBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg text-sm hover:bg-blue-700">Fazer Backup Agora</button>
                    <button id="dismissBackupReminderBtn" class="flex-1 bg-gray-100 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm hover:bg-gray-200">Lembrar Depois</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, writeBatch, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const IMGBB_API_KEY = "f012978df48f3596b193c06e05589442";
        
        // CONFIGURAÇÃO PARA AMBIENTE DE TESTES (Staging)
        const firebaseConfig = {
          apiKey: "AIzaSyDZrgh2y3d0fiv5uF_d73Syuo54_39L__8",
          authDomain: "saas-teste-c8d7a.firebaseapp.com",
          projectId: "saas-teste-c8d7a",
          storageBucket: "saas-teste-c8d7a.appspot.com",
          messagingSenderId: "281601947474",
          appId: "1:281601947474:web:1e580dbb06b685bf5d2c8b"
        };
        
        const isProduction = firebaseConfig.projectId === 'saas-57e0d';

        let app, db, auth, userId = null, dbCollection, transactionsCollection, pricingCollection;
        let allOrders = [], allTransactions = [], allPricingItems = [];
        let partCounter = 0;
        let userCompanyId = null, userCompanyName = null;
        let currentDashboardView = 'orders';
        let currentOrdersView = 'pending';

        const SIZES_ORDER = [
            'PP', 'P', 'M', 'G', 'GG', 'XG',
            '2 anos', '4 anos', '6 anos', '8 anos', '10 anos', '12 anos'
        ];

        const DOM = {
            authContainer: document.getElementById('authContainer'),
            loginForm: document.getElementById('loginForm'),
            forgotPasswordBtn: document.getElementById('forgotPasswordBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userEmail: document.getElementById('userEmail'),
            app: document.getElementById('app'),
            addOrderBtn: document.getElementById('addOrderBtn'),
            backupBtn: document.getElementById('backupBtn'),
            restoreFileInput: document.getElementById('restoreFile'),
            orderModal: document.getElementById('orderModal'),
            orderForm: document.getElementById('orderForm'),
            mainContent: document.getElementById('mainContent'),
            ordersDashboard: document.getElementById('ordersDashboard'),
            financeDashboard: document.getElementById('financeDashboard'),
            ordersList: document.getElementById('ordersList'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            partsContainer: document.getElementById('partsContainer'),
            financialsContainer: document.getElementById('financialsContainer'),
            addPartBtn: document.getElementById('addPartBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            saveBtn: document.getElementById('saveBtn'),
            uploadIndicator: document.getElementById('uploadIndicator'),
            viewModal: document.getElementById('viewModal'),
            infoModal: document.getElementById('infoModal'),
            infoModalMessage: document.getElementById('infoModalMessage'),
            infoModalCloseBtn: document.getElementById('infoModalCloseBtn'),
            grandTotal: document.getElementById('grandTotal'),
            remainingTotal: document.getElementById('remainingTotal'),
            downPayment: document.getElementById('downPayment'),
            idleModal: document.getElementById('idleModal'),
            stayLoggedInBtn: document.getElementById('stayLoggedInBtn'),
            countdownTimer: document.getElementById('countdownTimer'),
            optionsModal: document.getElementById('optionsModal'),
            optionsModalTitle: document.getElementById('optionsModalTitle'),
            optionsList: document.getElementById('optionsList'),
            newOptionInput: document.getElementById('newOptionInput'),
            addOptionBtn: document.getElementById('addOptionBtn'),
            closeOptionsModalBtn: document.getElementById('closeOptionsModalBtn'),
            partTypeList: document.getElementById('part-type-list'),
            partMaterialList: document.getElementById('part-material-list'),
            confirmModal: document.getElementById('confirmModal'),
            confirmModalMessage: document.getElementById('confirmModalMessage'),
            confirmOkBtn: document.getElementById('confirmOkBtn'),
            confirmCancelBtn: document.getElementById('confirmCancelBtn'),
            toggleViewBtn: document.getElementById('toggleViewBtn'),
            financeDashboardBtn: document.getElementById('financeDashboardBtn'),
            userMenuBtn: document.getElementById('userMenuBtn'),
            userDropdown: document.getElementById('userDropdown'),
            transactionModal: document.getElementById('transactionModal'),
            transactionForm: document.getElementById('transactionForm'),
            transactionModalTitle: document.getElementById('transactionModalTitle'),
            cancelTransactionBtn: document.getElementById('cancelTransactionBtn'),
            addIncomeBtn: document.getElementById('addIncomeBtn'),
            addExpenseBtn: document.getElementById('addExpenseBtn'),
            transactionsList: document.getElementById('transactionsList'),
            periodFilter: document.getElementById('periodFilter'),
            faturamentoBruto: document.getElementById('faturamentoBruto'),
            despesasTotais: document.getElementById('despesasTotais'),
            contasAReceber: document.getElementById('contasAReceber'),
            lucroLiquido: document.getElementById('lucroLiquido'),
            backupReminderBanner: document.getElementById('backupReminderBanner'),
            backupNowBtn: document.getElementById('backupNowBtn'),
            dismissBackupReminderBtn: document.getElementById('dismissBackupReminderBtn'),
            copyReportBtn: document.getElementById('copyReportBtn'),
            customPeriodContainer: document.getElementById('customPeriodContainer'),
            startDateInput: document.getElementById('startDateInput'),
            endDateInput: document.getElementById('endDateInput'),
            transactionCategory: document.getElementById('transactionCategory'),
            topExpensesByCategory: document.getElementById('topExpensesByCategory'),
            topIncomesByCategory: document.getElementById('topIncomesByCategory'),
            transactionSearchInput: document.getElementById('transactionSearchInput'),
            priceTableBtn: document.getElementById('priceTableBtn'),
            priceTableModal: document.getElementById('priceTableModal'),
            priceTableModalTitle: document.getElementById('priceTableModalTitle'),
            priceTableContainer: document.getElementById('priceTableContainer'),
            priceTableFooter: document.getElementById('priceTableFooter'),
            priceTableEditMessage: document.getElementById('priceTableEditMessage'),
            editPriceTableBtn: document.getElementById('editPriceTableBtn'),
            addPriceItemBtn: document.getElementById('addPriceItemBtn'),
            savePriceTableBtn: document.getElementById('savePriceTableBtn'),
            cancelPriceTableBtn: document.getElementById('cancelPriceTableBtn'),
            closePriceTableBtn: document.getElementById('closePriceTableBtn'),
        };

        const showInfoModal = (message) => {
            DOM.infoModalMessage.textContent = message;
            DOM.infoModal.classList.remove('hidden');
        };

        const handleForgotPassword = async (e) => {
            e.preventDefault();
            const email = prompt("Por favor, digite o e-mail da sua conta para redefinir a senha:");
            if (!email) {
                return;
            }
            
            try {
                await sendPasswordResetEmail(auth, email);
                showInfoModal("Se uma conta existir para este e-mail, um link para redefinição de senha foi enviado.");
            } catch (error) {
                // For security, show the same message even if there's an error (e.g., user not found).
                console.error("Erro na tentativa de redefinição de senha (silenciado para o usuário):", error.code);
                showInfoModal("Se uma conta existir para este e-mail, um link para redefinição de senha foi enviado.");
            }
        };
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let errorMessage = "E-mail ou senha incorretos."; 
                if (!isProduction) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = "Erro de Diagnóstico (Testes): Usuário não encontrado.";
                            break;
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = "Erro de Diagnóstico (Testes): Senha inválida para este e-mail.";
                            break;
                        case 'auth/user-disabled':
                            errorMessage = "Erro de Diagnóstico (Testes): Esta conta de usuário foi desativada.";
                            break;
                        default:
                            errorMessage = `Erro de Diagnóstico (Testes): ${error.code}`;
                            break;
                    }
                }
                showInfoModal(errorMessage);
            }
        };

        const handleLogout = () => {
            signOut(auth).catch(error => console.error("Erro ao fazer logout:", error));
        };

        const initializeAppLogic = async (user) => {
            userId = user.uid;
            const userMappingRef = doc(db, "user_mappings", userId);
            const userMappingSnap = await getDoc(userMappingRef);
            
            if (userMappingSnap.exists()) {
                userCompanyId = userMappingSnap.data().companyId;

                const companyRef = doc(db, "companies", userCompanyId);
                const companySnap = await getDoc(companyRef);
                if (companySnap.exists() && companySnap.data().companyName) {
                    userCompanyName = companySnap.data().companyName;
                } else {
                    userCompanyName = user.email; 
                }
                DOM.userEmail.textContent = userCompanyName;
                
                dbCollection = collection(db, `companies/${userCompanyId}/orders`);
                transactionsCollection = collection(db, `companies/${userCompanyId}/transactions`);
                pricingCollection = collection(db, `companies/${userCompanyId}/pricing`);
                
                setupFirestoreListener();
                setupTransactionsListener();
                setupPricingListener();
                
                resetIdleTimer();
                initializeAndPopulateDatalists();
                checkBackupReminder();
            } else {
                showInfoModal("Erro: Usuário não associado a nenhuma empresa. Fale com o suporte.");
                handleLogout();
            }
        };

        const initializeFirebase = () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        DOM.authContainer.classList.add('hidden');
                        DOM.app.classList.remove('hidden');
                        initializeAppLogic(user);
                    } else {
                        DOM.app.classList.add('hidden');
                        DOM.authContainer.classList.remove('hidden');
                        userCompanyId = null;
                        userCompanyName = null;
                    }
                });
            } catch (error) {
                console.error("Erro crítico de inicialização:", error);
                showInfoModal("Ocorreu um erro crítico ao iniciar a aplicação.");
            }
        };

        let idleTimeout, countdownInterval;
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000;
        const COUNTDOWN_SECONDS = 60;
        const startCountdown = () => {
            DOM.idleModal.classList.remove('hidden');
            let secondsLeft = COUNTDOWN_SECONDS;
            DOM.countdownTimer.textContent = secondsLeft;
            countdownInterval = setInterval(() => {
                secondsLeft--;
                DOM.countdownTimer.textContent = secondsLeft;
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    handleLogout();
                }
            }, 1000);
        };

        const resetIdleTimer = () => {
            clearTimeout(idleTimeout);
            clearInterval(countdownInterval);
            DOM.idleModal.classList.add('hidden');
            idleTimeout = setTimeout(startCountdown, IDLE_TIMEOUT_MS);
        };
        
        const defaultOptions = {
            partTypes: ['Gola redonda manga curta', 'Gola redonda manga longa', 'Gola redonda manga longa com capuz', 'Gola redonda manga curta (sublimada na frente)', 'Gola polo manga curta', 'Gola polo manga longa', 'Gola V manga curta', 'Gola V manga longa', 'Short', 'Calça'],
            materialTypes: ['Malha fria', 'Drifity', 'Cacharrel', 'PP', 'Algodão Fio 30', 'TNT drive', 'Piquê', 'Brim']
        };

        const getOptionsFromStorage = (type) => {
            const stored = localStorage.getItem(`${userCompanyId}_${type}`);
            return stored ? JSON.parse(stored) : defaultOptions[type];
        };

        const saveOptionsToStorage = (type, options) => {
            localStorage.setItem(`${userCompanyId}_${type}`, JSON.stringify(options));
        };
        
        const populateDatalists = () => {
            const partTypes = getOptionsFromStorage('partTypes');
            const materialTypes = getOptionsFromStorage('materialTypes');
            DOM.partTypeList.innerHTML = partTypes.map(opt => `<option value="${opt}"></option>`).join('');
            DOM.partMaterialList.innerHTML = materialTypes.map(opt => `<option value="${opt}"></option>`).join('');
        };

        const initializeAndPopulateDatalists = () => {
            if (!localStorage.getItem(`${userCompanyId}_partTypes`)) saveOptionsToStorage('partTypes', defaultOptions.partTypes);
            if (!localStorage.getItem(`${userCompanyId}_materialTypes`)) saveOptionsToStorage('materialTypes', defaultOptions.materialTypes);
            populateDatalists();
        };

        let currentOptionType = '';
        const openOptionsModal = (type) => {
            currentOptionType = type;
            const title = type === 'partTypes' ? 'Tipos de Peça' : 'Tipos de Material';
            const options = getOptionsFromStorage(type);
            DOM.optionsModalTitle.textContent = `Gerenciar ${title}`;
            DOM.optionsList.innerHTML = options.map((opt, index) =>
                `<div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                    <span>${opt}</span>
                    <button class="delete-option-btn text-red-500 hover:text-red-700 font-bold" data-index="${index}">&times;</button>
                </div>`
            ).join('');
            DOM.optionsModal.classList.remove('hidden');
        };
        const addOption = () => {
            const newOption = DOM.newOptionInput.value.trim();
            if (newOption && currentOptionType) {
                let options = getOptionsFromStorage(currentOptionType);
                if (!options.includes(newOption)) {
                    options.push(newOption);
                    saveOptionsToStorage(currentOptionType, options);
                    populateDatalists();
                    openOptionsModal(currentOptionType);
                    DOM.newOptionInput.value = '';
                }
            }
        };
        const deleteOption = (index) => {
            if (currentOptionType) {
                let options = getOptionsFromStorage(currentOptionType);
                options.splice(index, 1);
                saveOptionsToStorage(currentOptionType, options);
                populateDatalists();
                openOptionsModal(currentOptionType);
            }
        };
        
        const setupFirestoreListener = () => {
            if (!dbCollection) return;
            onSnapshot(query(dbCollection), (snapshot) => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders();
            }, (error) => {
                console.error("Erro ao buscar pedidos:", error);
                DOM.loadingIndicator.style.display = 'none';
                DOM.ordersList.innerHTML = '<p class="w-full text-center text-gray-500 col-span-full">Erro ao carregar pedidos.</p>';
            });
        };

        const setupPricingListener = () => {
            if (!pricingCollection) return;
            const q = query(pricingCollection, orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                allPricingItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, (error) => {
                console.error("Erro ao carregar tabela de preços:", error);
                showInfoModal("Não foi possível carregar a tabela de preços.");
            });
        };

        const renderPriceTable = (mode = 'view') => {
            const isEditMode = mode === 'edit';
            DOM.priceTableContainer.innerHTML = ''; 

            let tableHTML = `
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-3 text-sm font-semibold text-gray-700 w-1/3">Serviço/Item</th>
                            <th class="p-3 text-sm font-semibold text-gray-700 w-1/2">Descrição</th>
                            <th class="p-3 text-sm font-semibold text-gray-700 text-right">Preço (R$)</th>
                            ${isEditMode ? '<th class="p-3 text-sm font-semibold text-gray-700 text-center w-16">Ação</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="priceTableBody"></tbody>
                </table>
            `;
            DOM.priceTableContainer.innerHTML = tableHTML;
            const tableBody = document.getElementById('priceTableBody');
            
            if (allPricingItems.length === 0 && !isEditMode) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-gray-500">Nenhum item na tabela de preços. Clique em "Editar" para adicionar.</td></tr>`;
            } else {
                 allPricingItems.forEach(item => {
                    tableBody.appendChild(createPriceTableRow(item, mode));
                 });
            }
            
            DOM.editPriceTableBtn.classList.toggle('hidden', isEditMode);
            DOM.closePriceTableBtn.classList.toggle('hidden', isEditMode);
            DOM.priceTableEditMessage.classList.toggle('hidden', !isEditMode);
            DOM.savePriceTableBtn.classList.toggle('hidden', !isEditMode);
            DOM.cancelPriceTableBtn.classList.toggle('hidden', !isEditMode);
            DOM.addPriceItemBtn.classList.toggle('hidden', !isEditMode);
        };
        
        const createPriceTableRow = (item, mode) => {
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.dataset.id = item.id;
            
            const price = (typeof item.price === 'number') ? item.price.toFixed(2) : '0.00';

            if (mode === 'edit') {
                 tr.innerHTML = `
                    <td class="p-2"><input type="text" class="p-2 border rounded-md w-full price-item-name" value="${item.name || ''}"></td>
                    <td class="p-2"><input type="text" class="p-2 border rounded-md w-full price-item-desc" value="${item.description || ''}"></td>
                    <td class="p-2"><input type="number" step="0.01" class="p-2 border rounded-md w-full text-right price-item-price" value="${price}"></td>
                    <td class="p-2 text-center"><button class="delete-price-item-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
                `;
            } else {
                tr.innerHTML = `
                    <td class="p-3 font-medium text-gray-800">${item.name || ''}</td>
                    <td class="p-3 text-gray-600">${item.description || ''}</td>
                    <td class="p-3 text-right font-semibold text-gray-800">R$ ${price}</td>
                `;
            }
            return tr;
        };

        const savePriceTable = async () => {
            const batch = writeBatch(db);
            let hasChanges = false;
            const tableRows = DOM.priceTableContainer.querySelectorAll('#priceTableBody tr');
            
            for (const row of tableRows) {
                const id = row.dataset.id;
                const name = row.querySelector('.price-item-name').value.trim();
                const description = row.querySelector('.price-item-desc').value.trim();
                const price = parseFloat(row.querySelector('.price-item-price').value) || 0;

                if (!name) continue; 

                if (id.startsWith('new-')) { 
                    const newDocRef = doc(pricingCollection);
                    batch.set(newDocRef, { name, description, price, createdAt: serverTimestamp() });
                    hasChanges = true;
                } else { 
                    const originalItem = allPricingItems.find(i => i.id === id);
                    if (originalItem.name !== name || originalItem.description !== description || originalItem.price !== price) {
                        const docRef = doc(pricingCollection, id);
                        batch.update(docRef, { name, description, price });
                        hasChanges = true;
                    }
                }
            }

            try {
                if (hasChanges) {
                    await batch.commit();
                    showInfoModal("Tabela de preços salva com sucesso!");
                }
                renderPriceTable('view');
            } catch (error) {
                console.error("Erro ao salvar tabela de preços:", error);
                showInfoModal("Ocorreu um erro ao salvar as alterações.");
            }
        };

        const getDeliveryCountdown = (deliveryDate) => {
            if (!deliveryDate) return { text: 'Sem data', color: 'gray' };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const delivery = new Date(deliveryDate + 'T00:00:00');
            const diffTime = delivery.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return { text: `Atrasado há ${Math.abs(diffDays)} dia(s)`, color: 'red' };
            if (diffDays === 0) return { text: 'Entrega hoje', color: 'red' };
            if (diffDays === 1) return { text: 'Resta 1 dia', color: 'yellow' };
            if (diffDays <= 3) return { text: `Restam ${diffDays} dias`, color: 'yellow' };
            return { text: `Restam ${diffDays} dias`, color: 'green' };
        };

        const renderOrders = () => {
            if (currentDashboardView !== 'orders') return;
            DOM.loadingIndicator.style.display = 'none';
            DOM.ordersList.className = ''; 

            if (currentOrdersView === 'pending') {
                DOM.ordersList.classList.add('kanban-board');
                const nonDeliveredOrders = allOrders.filter(o => o.orderStatus !== 'Entregue');
                
                if (nonDeliveredOrders.length === 0) {
                    DOM.ordersList.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Nenhum pedido pendente.</div>';
                    return;
                }
                
                nonDeliveredOrders.sort((a, b) => new Date(a.deliveryDate || '9999-12-31') - new Date(b.deliveryDate || '9999-12-31'));
                
                const groupedOrders = nonDeliveredOrders.reduce((acc, order) => {
                    const date = order.deliveryDate || 'Sem Data';
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(order);
                    return acc;
                }, {});

                let html = '';
                for (const date in groupedOrders) {
                    const orders = groupedOrders[date];
                    const formattedDate = date === 'Sem Data' ?
                        'Sem Data de Entrega' :
                        new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                    
                    html += `
                        <div class="kanban-column">
                            <h2 class="font-bold text-lg text-gray-700 mb-4 flex items-center">
                                ${formattedDate}
                                <span class="ml-2 text-sm font-medium bg-slate-200 text-slate-600 rounded-full px-2 py-0.5">${orders.length}</span>
                            </h2>
                            <div class="space-y-4">${orders.map(order => generateOrderCardHTML(order, 'pending')).join('')}</div>
                        </div>`;
                }
                DOM.ordersList.innerHTML = html;

            } else { 
                DOM.ordersList.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5', 'gap-6');
                const deliveredOrders = allOrders.filter(o => o.orderStatus === 'Entregue');
                
                if (deliveredOrders.length === 0) {
                    DOM.ordersList.innerHTML = '<p class="col-span-full text-center py-10 text-gray-500">Nenhum pedido entregue encontrado.</p>';
                    return;
                }
                
                deliveredOrders.sort((a, b) => new Date(b.deliveryDate || 0) - new Date(a.deliveryDate || 0));
                DOM.ordersList.innerHTML = deliveredOrders.map(order => generateOrderCardHTML(order, 'delivered')).join('');
            }
        };

        const generateOrderCardHTML = (order, viewType) => {
            let totalValue = 0;
            (order.parts || []).forEach(p => {
                 const standardQty = Object.values(p.sizes || {}).flatMap(cat => Object.values(cat)).reduce((s, c) => s + c, 0);
                 const specificQty = (p.specifics || []).length;
                 const standardSub = standardQty * (p.unitPriceStandard || p.unitPrice || 0);
                 const specificSub = specificQty * (p.unitPriceSpecific || p.unitPrice || 0);
                 totalValue += standardSub + specificSub;
            });
            const countdown = getDeliveryCountdown(order.deliveryDate);
            const countdownColorClasses = {
                red: 'bg-red-100 text-red-800',
                yellow: 'bg-yellow-100 text-yellow-800',
                green: 'bg-green-100 text-green-800',
                gray: 'bg-gray-100 text-gray-800'
            };

            const formattedDeliveryDate = order.deliveryDate 
                ? new Date(order.deliveryDate + 'T00:00:00').toLocaleDateString('pt-BR') 
                : 'A definir';
            
            const buttonsHtml = viewType === 'pending' 
                ? `<button data-id="${order.id}" class="edit-btn p-2 rounded-md text-gray-500 hover:bg-yellow-100 hover:text-yellow-700 transition-colors" title="Editar">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                  </button>` 
                : `<button data-id="${order.id}" class="replicate-btn p-2 rounded-md text-gray-500 hover:bg-green-100 hover:text-green-700 transition-colors" title="Replicar">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a1 1 0 102 0V5h6a1 1 0 100-2H5z" /></svg>
                  </button>`;

            return `
                <div class="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col space-y-3 transform hover:-translate-y-1">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-800">${order.clientName}</h3>
                        <span class="status-badge status-${order.orderStatus.replace(/\s/g, '-')}">${order.orderStatus}</span>
                    </div>
                    
                    ${viewType === 'pending' ? `<div class="text-sm font-medium text-gray-500 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span class="ml-1.5">Entrega: <strong>${formattedDeliveryDate}</strong></span>
                    </div>` : ''}

                    <p class="text-sm text-gray-600">Total: <span class="font-semibold text-blue-600">R$ ${totalValue.toFixed(2)}</span></p>

                    ${viewType === 'pending' ? `<div class="text-sm font-semibold py-1 px-2 rounded-full text-center ${countdownColorClasses[countdown.color]}">${countdown.text}</div>` : ''}
                    
                    <div class="flex space-x-2 items-center pt-3 border-t border-gray-100 mt-auto">
                        <button data-id="${order.id}" class="view-btn flex-1 bg-gray-100 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm hover:bg-gray-200 transition-colors">Detalhes</button>
                        ${buttonsHtml}
                        <button data-id="${order.id}" class="delete-btn p-2 rounded-md text-gray-500 hover:bg-red-100 hover:text-red-700 transition-colors" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>`;
        };
        
        const handleBackup = () => {
            if (allOrders.length === 0 && allTransactions.length === 0) {
                showInfoModal("Não há dados para fazer backup.");
                return;
            }
            
            const backupData = {
                orders: allOrders.map(({ id, ...rest }) => rest),
                transactions: allTransactions.map(({ id, ...rest }) => rest)
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            link.download = `backup-completo-${date}.json`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showInfoModal("Backup completo gerado com sucesso!");
            localStorage.setItem(`backupTimestamp_${userCompanyId}`, Date.now());
        };

        const handleRestore = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dataFromFile = JSON.parse(e.target.result);
                    let ordersToRestore = [];
                    let transactionsToRestore = [];

                    // Retro-compatibility check
                    if (Array.isArray(dataFromFile)) { // Old format (just an array of orders)
                        ordersToRestore = dataFromFile;
                        showInfoModal("Backup de formato antigo detectado. Apenas os pedidos serão restaurados.");
                    } else if (typeof dataFromFile === 'object' && dataFromFile.orders) { // New format
                        ordersToRestore = dataFromFile.orders || [];
                        transactionsToRestore = dataFromFile.transactions || [];
                    } else {
                        throw new Error("Formato de arquivo de backup inválido.");
                    }
                    
                    if (!Array.isArray(ordersToRestore) || !Array.isArray(transactionsToRestore)) {
                         throw new Error("Dados de backup corrompidos.");
                    }

                    await processRestore(ordersToRestore, transactionsToRestore);
                } catch (error) {
                    console.error("Erro na restauração:", error);
                    showInfoModal("Arquivo de backup inválido ou corrompido.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input to allow re-uploading the same file
        };

        const processRestore = async (ordersToRestore, transactionsToRestore) => {
            const choice = await showConfirmModal("Escolha o modo de importação:", "Adicionar aos existentes", "Substituir tudo");
            if (choice === null) return; // User cancelled

            if (choice) { // ADICIONAR
                const batch = writeBatch(db);
                ordersToRestore.forEach(order => {
                    const newDocRef = doc(dbCollection); // dbCollection is orders
                    batch.set(newDocRef, order);
                });
                transactionsToRestore.forEach(transaction => {
                    const newDocRef = doc(transactionsCollection);
                    batch.set(newDocRef, transaction);
                });
                await batch.commit();
                showInfoModal(`${ordersToRestore.length} pedido(s) e ${transactionsToRestore.length} lançamento(s) foram ADICIONADOS.`);
            } else { // SUBSTITUIR
                const confirmReplace = await showConfirmModal(
                    "ATENÇÃO: Isto vai APAGAR TODOS os seus pedidos E lançamentos financeiros atuais. A ação NÃO PODE SER DESFEITA. Continuar?",
                    "Sim, substituir tudo",
                    "Cancelar"
                );
                if (confirmReplace) {
                    // --- Deletion Phase ---
                    const deleteBatch = writeBatch(db);
                    const allOrdersQuery = query(dbCollection);
                    const allTransactionsQuery = query(transactionsCollection);
                    
                    const [ordersSnap, transactionsSnap] = await Promise.all([
                        getDocs(allOrdersQuery),
                        getDocs(allTransactionsQuery)
                    ]);

                    ordersSnap.forEach(docSnap => deleteBatch.delete(docSnap.ref));
                    transactionsSnap.forEach(docSnap => deleteBatch.delete(docSnap.ref));
                    
                    if(ordersSnap.size > 0 || transactionsSnap.size > 0) {
                        await deleteBatch.commit();
                    }

                    // --- Addition Phase ---
                    const addBatch = writeBatch(db);
                    ordersToRestore.forEach(order => {
                        const newDocRef = doc(dbCollection);
                        addBatch.set(newDocRef, order);
                    });
                    transactionsToRestore.forEach(transaction => {
                        const newDocRef = doc(transactionsCollection);
                        addBatch.set(newDocRef, transaction);
                    });

                    if (ordersToRestore.length > 0 || transactionsToRestore.length > 0) {
                        await addBatch.commit();
                    }
                    
                    showInfoModal(`Dados substituídos. ${ordersToRestore.length} pedido(s) e ${transactionsToRestore.length} lançamento(s) importados.`);
                }
            }
        };

        const updateFinancials = () => {
            let grandTotal = 0;
            DOM.financialsContainer.querySelectorAll('.financial-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.financial-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.financial-price').value) || 0;
                const subtotal = quantity * price;
                item.querySelector('.financial-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
                grandTotal += subtotal;
            });
            const downPayment = parseFloat(DOM.downPayment.value) || 0;
            DOM.grandTotal.textContent = `R$ ${grandTotal.toFixed(2)}`;
            DOM.remainingTotal.textContent = `R$ ${(grandTotal - downPayment).toFixed(2)}`;
        };
        
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const uploadToImgBB = async (base64Image) => {
            const formData = new FormData();
            formData.append('image', base64Image);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) return data.data.url;
                throw new Error(data.error.message);
            } catch (error) {
                console.error('Erro no upload para ImgBB:', error);
                return null;
            }
        };

        const addPart = (partData = {}) => {
            partCounter++;
            const partTpl = document.getElementById('partTemplate').content.cloneNode(true);
            const partItem = partTpl.querySelector('.part-item');
            partItem.dataset.partId = partCounter;
            partItem.dataset.partType = partData.partInputType || 'comum';
            
            const partTypeInput = partItem.querySelector('.part-type');
            partTypeInput.value = partData.type || '';
            partItem.querySelector('.part-material').value = partData.material || '';
            partItem.querySelector('.part-color-main').value = partData.colorMain || '';
            
            partTypeInput.addEventListener('input', renderFinancialSection);
            
            addContentToPart(partItem, partData);
            DOM.partsContainer.appendChild(partItem);
            
            renderFinancialSection();
            
            partItem.querySelector('.remove-part-btn').addEventListener('click', () => {
                partItem.remove();
                renderFinancialSection();
            });
            partItem.querySelectorAll('.manage-options-btn').forEach(btn => btn.addEventListener('click', (e) => openOptionsModal(e.target.dataset.type)));
            partItem.querySelectorAll('.part-type-selector').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newType = e.target.dataset.type;
                    partItem.dataset.partType = newType;
                    addContentToPart(partItem, {}); 
                    renderFinancialSection();
                });
            });
        };

        const addContentToPart = (partItem, partData = {}) => {
            const contentContainer = partItem.querySelector('.part-content-container');
            contentContainer.innerHTML = '';
            const partId = partItem.dataset.partId;
            const partType = partItem.dataset.partType;

            partItem.querySelectorAll('.part-type-selector').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === partType);
            });

            if (partType === 'comum') {
                const comumTpl = document.getElementById('comumPartContentTemplate').content.cloneNode(true);
                
                const sizesGrid = comumTpl.querySelector('.sizes-grid');
                const categories = {
                    'Baby Look': ['PP', 'P', 'M', 'G', 'GG', 'XG'],
                    'Normal': ['PP', 'P', 'M', 'G', 'GG', 'XG'],
                    'Infantil': ['2 anos', '4 anos', '6 anos', '8 anos', '10 anos', '12 anos']
                };
                let gridHtml = '';
                for (const category in categories) {
                    gridHtml += `<div class="p-3 border rounded-md bg-white"><h4 class="font-semibold mb-2">${category}</h4><div class="grid grid-cols-3 sm:grid-cols-6 gap-4 justify-start">`;
                    categories[category].forEach(size => {
                        const value = partData.sizes?.[category]?.[size] || '';
                        gridHtml += `
                            <div class="size-input-container">
                                <label class="text-sm font-medium mb-1">${size}</label>
                                <input type="number" data-category="${category}" data-size="${size}" value="${value}" class="p-2 border rounded-md w-full text-center size-input">
                            </div>`;
                    });
                    gridHtml += '</div></div>';
                }
                sizesGrid.innerHTML = gridHtml;
                
                const specificList = comumTpl.querySelector('.specific-sizes-list');
                const addSpecificRow = (spec = {}) => {
                    const specTpl = document.getElementById('specificSizeRowTemplate').content.cloneNode(true);
                    specTpl.querySelector('.item-spec-width').value = spec.width || '';
                    specTpl.querySelector('.item-spec-height').value = spec.height || '';
                    specTpl.querySelector('.item-spec-obs').value = spec.observation || '';
                    specTpl.querySelector('.remove-specific-row-btn').addEventListener('click', (e) => {
                        e.target.closest('.specific-size-row').remove();
                        renderFinancialSection();
                    });
                    specificList.appendChild(specTpl);
                };

                (partData.specifics || []).forEach(addSpecificRow);

                comumTpl.querySelector('.add-specific-size-btn').addEventListener('click', () => {
                    addSpecificRow();
                    renderFinancialSection();
                });

                comumTpl.querySelector('.toggle-sizes-btn').addEventListener('click', (e) => e.target.nextElementSibling.classList.toggle('hidden'));
                sizesGrid.addEventListener('input', renderFinancialSection);
                contentContainer.appendChild(comumTpl);

            } else { // Modo 'detalhado'
                const detalhadoTpl = document.getElementById('detalhadoPartContentTemplate').content.cloneNode(true);
                const listContainer = detalhadoTpl.querySelector('.detailed-items-list');
                const addRow = (detail = {}) => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-12 gap-2 items-center detailed-item-row';
                    row.innerHTML = `
                        <div class="col-span-5"><input type="text" placeholder="Nome na Peça" class="p-1 border rounded-md w-full text-sm item-det-name" value="${detail.name || ''}"></div>
                        <div class="col-span-4"><input type="text" placeholder="Tamanho" class="p-1 border rounded-md w-full text-sm item-det-size" value="${detail.size || ''}"></div>
                        <div class="col-span-2"><input type="text" placeholder="Nº" class="p-1 border rounded-md w-full text-sm item-det-number" value="${detail.number || ''}"></div>
                        <div class="col-span-1 flex justify-center"><button type="button" class="remove-detailed-row text-red-500 font-bold">&times;</button></div>`;
                    row.querySelector('.remove-detailed-row').addEventListener('click', () => {
                        row.remove();
                        renderFinancialSection();
                    });
                    listContainer.appendChild(row);
                };
                (partData.details || [{}]).forEach(addRow);
                detalhadoTpl.querySelector('.add-detailed-row-btn').addEventListener('click', () => {
                    addRow();
                    renderFinancialSection();
                });
                contentContainer.appendChild(detalhadoTpl);
            }
        };

        const createFinancialRow = (partId, name, quantity, priceGroup) => {
            const finTpl = document.getElementById('financialRowTemplate').content.cloneNode(true);
            const finItem = finTpl.querySelector('.financial-item');
            finItem.dataset.partId = partId;
            finItem.dataset.priceGroup = priceGroup;

            finItem.querySelector('.financial-part-name > span:first-child').textContent = name;
            const label = priceGroup === 'standard' ? '(Padrão)' : priceGroup === 'specific' ? '(Específico)' : '';
            finItem.querySelector('.price-group-label').textContent = label;

            finItem.querySelector('.financial-quantity').value = quantity;
            finItem.querySelector('.financial-price').addEventListener('input', updateFinancials);

            return finItem;
        };

        const renderFinancialSection = () => {
            DOM.financialsContainer.innerHTML = '';
            DOM.partsContainer.querySelectorAll('.part-item').forEach(partItem => {
                const partId = partItem.dataset.partId;
                const partName = partItem.querySelector('.part-type').value || `Peça ${partId}`;
                const partType = partItem.dataset.partType;

                if (partType === 'comum') {
                    let standardQty = 0;
                    partItem.querySelectorAll('.size-input').forEach(input => {
                        standardQty += parseInt(input.value) || 0;
                    });
                    const specificQty = partItem.querySelectorAll('.specific-size-row').length;

                    if (standardQty > 0) {
                        const finRow = createFinancialRow(partId, partName, standardQty, 'standard');
                        DOM.financialsContainer.appendChild(finRow);
                    }
                    if (specificQty > 0) {
                        const finRow = createFinancialRow(partId, partName, specificQty, 'specific');
                        DOM.financialsContainer.appendChild(finRow);
                    }
                } else { // detalhado
                    const totalQty = partItem.querySelectorAll('.detailed-item-row').length;
                    if (totalQty > 0) {
                       const finRow = createFinancialRow(partId, partName, totalQty, 'detailed');
                       DOM.financialsContainer.appendChild(finRow);
                    }
                }
            });
            updateFinancials();
        };

        const collectFormData = () => {
            const orderData = {
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                orderStatus: document.getElementById('orderStatus').value,
                orderDate: document.getElementById('orderDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                generalObservation: document.getElementById('generalObservation').value,
                parts: [],
                downPayment: parseFloat(DOM.downPayment.value) || 0,
                paymentMethod: document.getElementById('paymentMethod').value,
                mockupUrls: Array.from(document.getElementById('existingFilesContainer').querySelectorAll('a')).map(a => a.href)
            };
            
            DOM.partsContainer.querySelectorAll('.part-item').forEach(pItem => {
                const partId = pItem.dataset.partId;
                const part = {
                    type: pItem.querySelector('.part-type').value,
                    material: pItem.querySelector('.part-material').value,
                    colorMain: pItem.querySelector('.part-color-main').value,
                    partInputType: pItem.dataset.partType,
                    sizes: {},
                    details: [],
                    specifics: [],
                    unitPriceStandard: 0,
                    unitPriceSpecific: 0,
                    unitPrice: 0 // For detailed type and backward compatibility
                };

                if (part.partInputType === 'comum') {
                    pItem.querySelectorAll('.size-input').forEach(input => {
                        if (input.value) {
                            const { category, size } = input.dataset;
                            if (!part.sizes[category]) part.sizes[category] = {};
                            part.sizes[category][size] = parseInt(input.value, 10);
                        }
                    });
                    pItem.querySelectorAll('.specific-size-row').forEach(row => {
                        const width = row.querySelector('.item-spec-width').value.trim();
                        const height = row.querySelector('.item-spec-height').value.trim();
                        const observation = row.querySelector('.item-spec-obs').value.trim();
                        if (width || height || observation) {
                           part.specifics.push({ width, height, observation });
                        }
                    });
                    const standardPriceRow = DOM.financialsContainer.querySelector(`.financial-item[data-part-id="${partId}"][data-price-group="standard"]`);
                    if(standardPriceRow) part.unitPriceStandard = parseFloat(standardPriceRow.querySelector('.financial-price').value) || 0;
                    
                    const specificPriceRow = DOM.financialsContainer.querySelector(`.financial-item[data-part-id="${partId}"][data-price-group="specific"]`);
                    if(specificPriceRow) part.unitPriceSpecific = parseFloat(specificPriceRow.querySelector('.financial-price').value) || 0;

                } else { // detalhado
                    pItem.querySelectorAll('.detailed-item-row').forEach(row => {
                        const name = row.querySelector('.item-det-name').value;
                        const size = row.querySelector('.item-det-size').value;
                        const number = row.querySelector('.item-det-number').value;
                        if (name || size || number) {
                            part.details.push({ name, size, number });
                        }
                    });
                    const detailedPriceRow = DOM.financialsContainer.querySelector(`.financial-item[data-part-id="${partId}"][data-price-group="detailed"]`);
                    if(detailedPriceRow) part.unitPrice = parseFloat(detailedPriceRow.querySelector('.financial-price').value) || 0;
                }
                orderData.parts.push(part);
            });
            return orderData;
        };

        const saveOrder = async (e) => {
            e.preventDefault();
            DOM.saveBtn.disabled = true;
            DOM.uploadIndicator.classList.remove('hidden');

            try {
                const files = document.getElementById('mockupFiles').files;
                const uploadPromises = Array.from(files).map(file => fileToBase64(file).then(uploadToImgBB));
                const newUrls = (await Promise.all(uploadPromises)).filter(Boolean);

                const orderData = collectFormData();
                orderData.mockupUrls.push(...newUrls);

                const orderId = document.getElementById('orderId').value;
                const oldOrder = orderId ? allOrders.find(o => o.id === orderId) : null;
                
                if (orderId) {
                    await updateDoc(doc(dbCollection, orderId), orderData);
                } else {
                    await addDoc(dbCollection, orderData);
                }
                
                DOM.orderModal.classList.add('hidden');
                
                const newStatus = orderData.orderStatus;
                const oldStatus = oldOrder ? oldOrder.orderStatus : null;
                const isNowCompleted = (newStatus === 'Finalizado' || newStatus === 'Entregue');
                const wasNotCompletedBefore = (oldStatus !== 'Finalizado' && oldStatus !== 'Entregue');

                if (isNowCompleted && wasNotCompletedBefore) {
                    const generateReceipt = await showConfirmModal("Pedido salvo! Deseja gerar um recibo de quitação?", "Sim, Gerar Recibo", "Não, Obrigado");
                    if (generateReceipt) {
                        generateReceiptPdf(orderData);
                    }
                }

            } catch (error) {
                console.error("ERRO DETALHADO AO SALVAR:", error);
                showInfoModal('Erro ao salvar o pedido.');
            } finally {
                DOM.saveBtn.disabled = false;
                DOM.uploadIndicator.classList.add('hidden');
            }
        };

        const editOrder = (orderData) => {
            resetForm();
            
            document.getElementById('orderId').value = orderData.id;
            document.getElementById('modalTitle').textContent = 'Editar Pedido';
            document.getElementById('clientName').value = orderData.clientName;
            document.getElementById('clientPhone').value = orderData.clientPhone;
            document.getElementById('orderStatus').value = orderData.orderStatus;
            document.getElementById('orderDate').value = orderData.orderDate;
            document.getElementById('deliveryDate').value = orderData.deliveryDate;
            document.getElementById('generalObservation').value = orderData.generalObservation;
            DOM.downPayment.value = orderData.downPayment || 0;
            document.getElementById('paymentMethod').value = orderData.paymentMethod || '';

            const filesContainer = document.getElementById('existingFilesContainer');
            filesContainer.innerHTML = '';
            if (orderData.mockupUrls && orderData.mockupUrls.length) {
                orderData.mockupUrls.forEach(url => {
                    const fileWrapper = document.createElement('div');
                    fileWrapper.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-md';
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.className = 'text-blue-600 hover:underline text-sm truncate';
                    link.textContent = url.split('/').pop().split('?')[0];
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'remove-mockup-btn text-red-500 hover:text-red-700 font-bold ml-2 px-2';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Remover anexo';

                    fileWrapper.appendChild(link);
                    fileWrapper.appendChild(deleteBtn);
                    filesContainer.appendChild(fileWrapper);
                });
            }

            (orderData.parts || []).forEach(addPart);
            
            // Populate prices after financial rows are rendered
            DOM.financialsContainer.querySelectorAll('.financial-item').forEach(finRow => {
                const partId = finRow.dataset.partId;
                const priceGroup = finRow.dataset.priceGroup;
                const part = orderData.parts[partId - 1];
                if (!part) return;

                if (priceGroup === 'standard') {
                    finRow.querySelector('.financial-price').value = part.unitPriceStandard || part.unitPrice || '';
                } else if (priceGroup === 'specific') {
                    finRow.querySelector('.financial-price').value = part.unitPriceSpecific || part.unitPrice || '';
                } else if (priceGroup === 'detailed') {
                    finRow.querySelector('.financial-price').value = part.unitPrice || '';
                }
            });

            updateFinancials();
            DOM.orderModal.classList.remove('hidden');
        };

        const replicateOrder = (orderId) => {
            const orderData = allOrders.find(o => o.id === orderId);
            if (!orderData) return;
            editOrder(orderData);
            document.getElementById('orderId').value = '';
            document.getElementById('modalTitle').textContent = 'Novo Pedido (Replicado)';
            document.getElementById('orderStatus').value = 'Pendente';
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = '';
        };

        const showConfirmModal = (message, okText = "OK", cancelText = "Cancelar") => {
            return new Promise((resolve) => {
                DOM.confirmModalMessage.textContent = message;
                DOM.confirmOkBtn.textContent = okText;
                DOM.confirmCancelBtn.textContent = cancelText;
                DOM.confirmModal.classList.remove('hidden');

                const confirmListener = () => resolvePromise(true);
                const cancelListener = () => resolvePromise(false);

                const resolvePromise = (value) => {
                    DOM.confirmModal.classList.add('hidden');
                    DOM.confirmOkBtn.removeEventListener('click', confirmListener);
                    DOM.confirmCancelBtn.removeEventListener('click', cancelListener);
                    resolve(value);
                };

                DOM.confirmOkBtn.addEventListener('click', confirmListener);
                DOM.confirmCancelBtn.addEventListener('click', cancelListener);
            });
        };

        const deleteOrder = async (id) => {
            const confirmed = await showConfirmModal("Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.", "Excluir", "Cancelar");
            if (confirmed) {
                try {
                    await deleteDoc(doc(dbCollection, id));
                    showInfoModal("Pedido excluído com sucesso.");
                } catch (error) {
                    console.error("Erro ao excluir pedido:", error);
                    showInfoModal("Não foi possível excluir o pedido.");
                }
            }
        };

        const resetForm = () => {
            DOM.orderForm.reset();
            document.getElementById('orderId').value = '';
            document.getElementById('modalTitle').textContent = 'Novo Pedido';
            DOM.partsContainer.innerHTML = '';
            DOM.financialsContainer.innerHTML = '';
            document.getElementById('existingFilesContainer').innerHTML = '';
            partCounter = 0;
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            updateFinancials();
        };

        const sortSizes = (sizesObject) => {
            return Object.entries(sizesObject).sort((a, b) => {
                const indexA = SIZES_ORDER.indexOf(a[0]);
                const indexB = SIZES_ORDER.indexOf(b[0]);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        };
        
        const viewOrder = (orderId) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            let totalValue = 0;
            let partsHtml = (order.parts || []).map(p => {
                const standardQty = Object.values(p.sizes || {}).flatMap(cat => Object.values(cat)).reduce((s, c) => s + c, 0);
                const specificQty = (p.specifics || []).length;
                const detailedQty = (p.details || []).length;

                const standardSub = standardQty * (p.unitPriceStandard !== undefined ? p.unitPriceStandard : p.unitPrice || 0);
                const specificSub = specificQty * (p.unitPriceSpecific !== undefined ? p.unitPriceSpecific : p.unitPrice || 0);
                const detailedSub = detailedQty * (p.unitPrice || 0);

                const subtotal = standardSub + specificSub + detailedSub;
                totalValue += subtotal;

                let itemsDetailHtml = '';
                
                if (p.partInputType === 'comum') {
                    let standardSizesHtml = '';
                    if (p.sizes && Object.keys(p.sizes).length > 0) {
                         standardSizesHtml = Object.entries(p.sizes).map(([cat, sizes]) =>
                             `<strong>${cat}:</strong> ${sortSizes(sizes).map(([size, qty]) => `${size}(${qty})`).join(', ')}`
                         ).join('<br>');
                    }
                    
                    let specificSizesHtml = '';
                    if (p.specifics && p.specifics.length > 0) {
                        specificSizesHtml = '<br><strong>Específicos:</strong><br>' + p.specifics.map(s => 
                            `&nbsp;&nbsp;- L: ${s.width || 'N/A'}, A: ${s.height || 'N/A'} (${s.observation || 'Sem obs.'})`
                        ).join('<br>');
                    }

                    if (standardSizesHtml || specificSizesHtml) {
                       itemsDetailHtml = `<div class="text-xs text-gray-600 pl-2 mt-1">${standardSizesHtml}${specificSizesHtml}</div>`;
                    }

                } else if (p.partInputType === 'detalhado' && p.details && p.details.length > 0) {
                    itemsDetailHtml = '<div class="text-xs text-gray-600 pl-2 mt-1">' + p.details.map(d => `${d.name || ''} - ${d.size || ''} - ${d.number || ''}`).join('<br>') + '</div>';
                }

                let unitPriceHtml = '';
                if(p.partInputType === 'comum') {
                    if(standardQty > 0) unitPriceHtml += `R$ ${(p.unitPriceStandard !== undefined ? p.unitPriceStandard : p.unitPrice || 0).toFixed(2)} (Padrão)<br>`;
                    if(specificQty > 0) unitPriceHtml += `R$ ${(p.unitPriceSpecific !== undefined ? p.unitPriceSpecific : p.unitPrice || 0).toFixed(2)} (Específico)`;
                } else {
                    unitPriceHtml = `R$ ${(p.unitPrice || 0).toFixed(2)}`;
                }


                return `
                    <tr>
                        <td class="py-1 px-2 border">${p.type}${itemsDetailHtml}</td>
                        <td class="py-1 px-2 border">${p.material}</td>
                        <td class="py-1 px-2 border">${p.colorMain}</td>
                        <td class="py-1 px-2 border text-center">${standardQty + specificQty + detailedQty}</td>
                        <td class="py-1 px-2 border text-right">${unitPriceHtml}</td>
                        <td class="py-1 px-2 border text-right font-semibold">R$ ${subtotal.toFixed(2)}</td>
                    </tr>`;
            }).join('');

            const modalContent = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                    <div id="printable-details" class="p-8 pb-8 overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4">Detalhes do Pedido - ${order.clientName}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm mb-4">
                            <div><strong>Telefone:</strong> ${order.clientPhone || 'N/A'}</div>
                            <div><strong>Status:</strong> <span class="font-semibold">${order.orderStatus}</span></div>
                            <div><strong>Data do Pedido:</strong> ${order.orderDate ? new Date(order.orderDate + 'T00:00:00').toLocaleDateString('pt-br') : 'N/A'}</div>
                            <div><strong>Data de Entrega:</strong> ${order.deliveryDate ? new Date(order.deliveryDate + 'T00:00:00').toLocaleDateString('pt-br') : 'N/A'}</div>
                        </div>
                        <h3 class="font-bold text-lg mt-4">Peças</h3>
                        <table class="w-full text-left text-sm mt-2">
                            <thead><tr class="bg-gray-100"><th class="px-2 py-1">Tipo/Detalhes</th><th class="px-2 py-1">Material</th><th class="px-2 py-1">Cor</th><th class="px-2 py-1 text-center">Qtd</th><th class="px-2 py-1 text-right">V. Un.</th><th class="px-2 py-1 text-right">Subtotal</th></tr></thead>
                            <tbody>${partsHtml}</tbody>
                        </table>
                        <h3 class="font-bold text-lg mt-4">Observação Geral</h3>
                        <p class="text-sm p-2 border rounded-md mt-2 min-h-[40px]">${order.generalObservation || 'Nenhuma.'}</p>
                        <h3 class="font-bold text-lg mt-4">Financeiro</h3>
                        <div class="grid grid-cols-2 gap-x-8 mt-2 border-t pt-4">
                            <div><strong>Valor Total:</strong> <span class="font-bold text-xl">R$ ${totalValue.toFixed(2)}</span></div>
                            <div><strong>Adiantamento:</strong> R$ ${(order.downPayment || 0).toFixed(2)}</div>
                            <div><strong>Forma de Pagamento:</strong> ${order.paymentMethod || 'N/A'}</div>
                            <div class="font-bold text-red-600 text-xl"><strong>Resta Pagar:</strong> R$ ${(totalValue - (order.downPayment || 0)).toFixed(2)}</div>
                        </div>
                        
                        <div id="mockupContainerView" class="pt-4 border-t mt-4">
                            <h3 class="font-bold text-lg">Arquivos</h3>
                            <div class="flex flex-wrap gap-4 mt-2">
                                ${(order.mockupUrls || []).map(url => `<a href="${url}" target="_blank"><img src="${url}" class="w-32 h-32 object-cover border rounded-md mockup-image"></a>`).join('') || 'Nenhum arquivo.'}
                            </div>
                        </div>

                        <div id="mockupContainerPdf" class="hidden">
                            <h3 class="font-bold text-lg mt-4">Arquivos</h3>
                            <div class="flex flex-wrap gap-4 mt-2">
                                ${(order.mockupUrls || []).map(url => `<img src="${url}" class="w-full h-auto object-contain border rounded-md mockup-image mt-4">`).join('') || ''}
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 border-t flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="comprehensivePdfBtn" data-name="${order.clientName}" data-id="${order.id}" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Gerar PDF do pedido</button>
                        <button id="closeViewBtn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Fechar</button>
                    </div>
                </div>`;
            DOM.viewModal.innerHTML = modalContent;
            DOM.viewModal.classList.remove('hidden');
        };

        const generateComprehensivePdf = async (orderId, clientName) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const element = document.getElementById('printable-details');
            const mockupContainer = document.getElementById('mockupContainerPdf');
            
            element.classList.remove('p-8', 'pb-8');

            mockupContainer.classList.remove('hidden');

            const options = {
                margin: 10,
                filename: `Pedido_${clientName.replace(/\s/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(element).set(options).save().finally(() => {
                mockupContainer.classList.add('hidden');
                element.classList.add('p-8', 'pb-8');
            });
        };
        
        const generateReceiptPdf = async (orderData) => {
            let totalValue = 0;
            (orderData.parts || []).forEach(p => {
                 const standardQty = Object.values(p.sizes || {}).flatMap(cat => Object.values(cat)).reduce((s, c) => s + c, 0);
                 const specificQty = (p.specifics || []).length;
                 const standardSub = standardQty * (p.unitPriceStandard || p.unitPrice || 0);
                 const specificSub = specificQty * (p.unitPriceSpecific || p.unitPrice || 0);
                 totalValue += standardSub + specificSub;
            });

            const today = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            const companyUser = userCompanyName || (auth.currentUser ? auth.currentUser.email : 'Sua Empresa');

            const receiptHtml = `
                <div style="font-family: Arial, sans-serif; padding: 40px; border: 1px solid #eee; width: 700px; margin: auto; background-color: white;">
                    <h1 style="text-align: center; font-size: 24px; margin-bottom: 40px; color: #333;">RECIBO DE QUITAÇÃO</h1>
                    <p style="font-size: 16px; line-height: 1.6; color: #555;">
                        Recebemos de <strong>${orderData.clientName || ''}</strong>, a importância de 
                        <strong>R$ ${totalValue.toFixed(2)}</strong>, referente à quitação total do pedido de 
                        ${(orderData.parts[0]?.type || 'fardamento personalizado').toLowerCase()}.
                    </p>
                    <p style="font-size: 14px; color: #777; margin-top: 30px;">
                        Declaramos que o valor acima foi integralmente recebido, não restando nenhum débito pendente referente a este pedido.
                    </p>
                    <p style="text-align: right; margin-top: 50px; font-size: 16px;">${today}</p>
                    <div style="margin-top: 80px; text-align: center;">
                        <div style="display: inline-block; border-top: 1px solid #333; width: 300px; padding-top: 8px; font-size: 14px;">
                            Assinatura ( ${companyUser} )
                        </div>
                    </div>
                </div>
            `;

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.padding = '20px';
            tempContainer.style.backgroundColor = 'white';
            tempContainer.innerHTML = receiptHtml;
            document.body.appendChild(tempContainer);
            
            try {
                const { jsPDF } = window;
                const canvas = await window.html2canvas(tempContainer.firstElementChild, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 5, 5, pdfWidth - 10, pdfHeight - 10);
                pdf.save(`Recibo_${orderData.clientName.replace(/\s/g, '_')}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF do Recibo:", error);
                showInfoModal("Não foi possível gerar o PDF do recibo.");
            } finally {
                document.body.removeChild(tempContainer);
            }
        };
        
        const setupTransactionsListener = () => {
            if (!transactionsCollection) return;
            onSnapshot(query(transactionsCollection), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (currentDashboardView === 'finance') {
                    renderFinanceDashboard();
                }
            }, (error) => {
                console.error("Erro ao carregar transações:", error);
                showInfoModal("Não foi possível carregar os dados financeiros.");
            });
        };

        const renderFinanceDashboard = () => {
            if (!DOM.periodFilter) return;

            const filterValue = DOM.periodFilter.value;
            const now = new Date();
            let startDate, endDate;

            if (filterValue === 'custom') {
                startDate = DOM.startDateInput.value ? new Date(DOM.startDateInput.value + 'T00:00:00') : null;
                endDate = DOM.endDateInput.value ? new Date(DOM.endDateInput.value + 'T23:59:59') : null;
            } else {
                const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfThisMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                const startOfThisYear = new Date(now.getFullYear(), 0, 1);
                const endOfThisYear = new Date(now.getFullYear(), 11, 31, 23, 59, 59);

                switch(filterValue) {
                    case 'thisMonth': startDate = startOfThisMonth; endDate = endOfThisMonth; break;
                    case 'lastMonth': startDate = startOfLastMonth; endDate = endOfLastMonth; break;
                    case 'thisYear': startDate = startOfThisYear; endDate = endOfThisYear; break;
                }
            }
            
            const filteredTransactions = allTransactions.filter(t => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                if (startDate && endDate) return transactionDate >= startDate && transactionDate <= endDate;
                if(startDate && !endDate) return transactionDate >= startDate;
                if(!startDate && endDate) return transactionDate <= endDate;
                return true;
            });

            let faturamentoBruto = 0;
            let despesasTotais = 0;
            let contasAReceber = 0;
            let valorRecebido = 0;

            filteredTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0;
                if (t.type === 'income') {
                    faturamentoBruto += amount;
                    if (t.status === 'a_receber') {
                        contasAReceber += amount;
                    } else {
                        valorRecebido += amount;
                    }
                } else if (t.type === 'expense') {
                    despesasTotais += amount;
                }
            });

            const lucroLiquido = valorRecebido - despesasTotais;

            DOM.faturamentoBruto.textContent = `R$ ${faturamentoBruto.toFixed(2)}`;
            DOM.despesasTotais.textContent = `R$ ${despesasTotais.toFixed(2)}`;
            DOM.contasAReceber.textContent = `R$ ${contasAReceber.toFixed(2)}`;
            DOM.lucroLiquido.textContent = `R$ ${lucroLiquido.toFixed(2)}`;

            const expenseCategories = {};
            const incomeCategories = {};

            filteredTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0;
                const category = t.category || 'Sem Categoria';

                if (t.type === 'expense') {
                    if (!expenseCategories[category]) expenseCategories[category] = 0;
                    expenseCategories[category] += amount;
                } else if (t.type === 'income') {
                    if (!incomeCategories[category]) incomeCategories[category] = 0;
                    incomeCategories[category] += amount;
                }
            });

            const formatCategoryList = (categoryData, containerElement) => {
                const sortedCategories = Object.entries(categoryData)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                if (sortedCategories.length === 0) {
                    containerElement.innerHTML = '<p class="text-sm text-gray-500">Nenhum dado no período.</p>';
                    return;
                }

                let html = '<ul class="space-y-2 text-sm">';
                sortedCategories.forEach(([category, total]) => {
                    html += `
                        <li class="flex justify-between items-center py-1">
                            <span class="text-gray-700 truncate pr-2">${category}</span>
                            <span class="font-semibold text-gray-900 whitespace-nowrap">R$ ${total.toFixed(2)}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                containerElement.innerHTML = html;
            };

            formatCategoryList(expenseCategories, DOM.topExpensesByCategory);
            formatCategoryList(incomeCategories, DOM.topIncomesByCategory);

            const searchTerm = DOM.transactionSearchInput.value.toLowerCase();
            const displayTransactions = searchTerm
                ? filteredTransactions.filter(t => t.description.toLowerCase().includes(searchTerm))
                : filteredTransactions;

            const transactionsHtml = displayTransactions.map(t => {
                const isIncome = t.type === 'income';
                const isReceivable = isIncome && t.status === 'a_receber';
                
                const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                const formattedDate = new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR');
                const transactionAmount = typeof t.amount === 'number' ? t.amount.toFixed(2) : '0.00';
                
                const statusBadge = isReceivable ? `<span class="ml-2 text-xs font-semibold py-1 px-2 rounded-full bg-yellow-100 text-yellow-800">A Receber</span>` : '';
                
                let actionsHtml = `
                    <button data-id="${t.id}" class="edit-transaction-btn text-blue-500 hover:underline text-sm">Editar</button>
                    <button data-id="${t.id}" class="delete-transaction-btn text-red-500 hover:underline text-sm ml-2">Excluir</button>
                `;

                if (isReceivable) {
                    actionsHtml = `<button data-id="${t.id}" class="mark-as-paid-btn text-green-600 hover:underline text-sm font-semibold">Receber</button> ` + actionsHtml;
                }

                return `
                    <tr class="border-b hover:bg-gray-50 ${isReceivable ? 'bg-yellow-50' : ''}">
                        <td class="py-3 px-4">${formattedDate}</td>
                        <td class="py-3 px-4 flex items-center">${t.description} ${statusBadge}</td>
                        <td class="py-3 px-4 text-gray-600">${t.category || ''}</td>
                        <td class="py-3 px-4 text-right font-semibold ${amountClass}">
                            ${isIncome ? '+' : '-'} R$ ${transactionAmount}
                        </td>
                        <td class="py-3 px-4 text-right">
                            ${actionsHtml}
                        </td>
                    </tr>`;
            }).join('');

            DOM.transactionsList.innerHTML = transactionsHtml || `<tr><td colspan="5" class="text-center py-4 text-gray-500">${searchTerm ? 'Nenhum lançamento encontrado para a busca.' : 'Nenhum lançamento encontrado para este período.'}</td></tr>`;
        };

        const saveTransaction = async () => {
            const transactionId = document.getElementById('transactionId').value;
            const transactionData = {
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value.trim()
            };

            if (!transactionData.date || !transactionData.description || isNaN(transactionData.amount) || transactionData.amount <= 0) {
                showInfoModal("Por favor, preencha todos os campos com valores válidos.");
                return;
            }

            if (transactionData.type === 'income') {
                transactionData.status = document.querySelector('input[name="transactionStatus"]:checked').value;
            } else {
                transactionData.status = 'pago';
            }

            try {
                if (transactionId) {
                    await updateDoc(doc(transactionsCollection, transactionId), transactionData);
                } else {
                    await addDoc(transactionsCollection, transactionData);
                }
                DOM.transactionForm.reset();
                DOM.transactionModal.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar lançamento:", error);
                showInfoModal("Não foi possível salvar o lançamento.");
            }
        };

        const editTransaction = (id) => {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionCategory').value = transaction.category || '';
            
            const statusContainer = document.getElementById('transactionStatusContainer');
            if (transaction.type === 'income') {
                statusContainer.classList.remove('hidden');
                document.querySelector(`input[name="transactionStatus"][value="${transaction.status || 'pago'}"]`).checked = true;
            } else {
                statusContainer.classList.add('hidden');
            }

            const title = transaction.type === 'income' ? 'Editar Entrada' : 'Editar Despesa';
            document.getElementById('transactionModalTitle').textContent = title;
            DOM.transactionModal.classList.remove('hidden');
        };

        const deleteTransaction = async (id) => {
            const confirmed = await showConfirmModal(
                "Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.",
                "Excluir", "Cancelar"
            );
            if (confirmed) {
                try {
                    await deleteDoc(doc(transactionsCollection, id));
                } catch (error) {
                    console.error("Erro ao excluir lançamento:", error);
                    showInfoModal("Não foi possível excluir o lançamento.");
                }
            }
        };

        const markTransactionAsPaid = async (id) => {
             const transactionRef = doc(transactionsCollection, id);
                 try {
                     await updateDoc(transactionRef, {
                         status: 'pago',
                         date: new Date().toISOString().split('T')[0]
                     });
                 } catch(error) {
                     console.error("Erro ao marcar como recebido:", error);
                     showInfoModal("Não foi possível atualizar o lançamento.");
                 }
        };
        
        const checkBackupReminder = () => {
            const lastBackupTimestamp = localStorage.getItem(`backupTimestamp_${userCompanyId}`);
            if (!lastBackupTimestamp) {
                return;
            }

            const now = Date.now();
            const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;
            
            if ((now - parseInt(lastBackupTimestamp)) > sevenDaysInMillis) {
                DOM.backupReminderBanner.classList.remove('hidden');
            }
        };
        
        const copyTransactionsToClipboard = async () => {
            const filterValue = DOM.periodFilter.value;
            const now = new Date();
            let startDate, endDate;

            if (filterValue === 'custom') {
                startDate = DOM.startDateInput.value ? new Date(DOM.startDateInput.value + 'T00:00:00') : null;
                endDate = DOM.endDateInput.value ? new Date(DOM.endDateInput.value + 'T23:59:59') : null;
            } else {
                const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfThisMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                const startOfThisYear = new Date(now.getFullYear(), 0, 1);
                const endOfThisYear = new Date(now.getFullYear(), 11, 31, 23, 59, 59);

                switch(filterValue) {
                    case 'thisMonth': startDate = startOfThisMonth; endDate = endOfThisMonth; break;
                    case 'lastMonth': startDate = startOfLastMonth; endDate = endOfLastMonth; break;
                    case 'thisYear': startDate = startOfThisYear; endDate = endOfThisYear; break;
                }
            }
            
            const transactionsToExport = allTransactions.filter(t => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                if (startDate && endDate) return transactionDate >= startDate && transactionDate <= endDate;
                if(startDate && !endDate) return transactionDate >= startDate;
                if(!startDate && endDate) return transactionDate <= endDate;
                return true;
            });

            if (transactionsToExport.length === 0) {
                showInfoModal("Não há dados para copiar no período selecionado.");
                return;
            }

            const headers = ['Data', 'Descricao', 'Categoria', 'Valor', 'Tipo', 'Status'];
            let reportString = headers.join('\t') + '\n';

            for (const t of transactionsToExport) {
                const value = t.type === 'income' ? t.amount : -t.amount;
                const formattedDate = new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR');
                
                const description = (t.description || '').replace(/\s+/g, ' ');
                const category = (t.category || '').replace(/\s+/g, ' ');

                const typeInPortuguese = t.type === 'income' ? 'Receita' : 'Despesa';
                const statusInPortuguese = t.status === 'a_receber' ? 'A Receber' : 'Pago';

                const row = [
                    formattedDate,
                    description,
                    category,
                    value.toFixed(2).replace('.',','),
                    typeInPortuguese,
                    statusInPortuguese
                ];
                reportString += row.join('\t') + '\n';
            }

            try {
                await navigator.clipboard.writeText(reportString);
                showInfoModal("Relatório copiado! Agora é só colar (Ctrl+V) em sua planilha.");
            } catch (err) {
                console.error('Falha ao copiar relatório: ', err);
                showInfoModal("Não foi possível copiar o relatório. Verifique as permissões do navegador.");
            }
        };

        // --- Event Listeners ---
        window.addEventListener('load', initializeFirebase);
        DOM.loginForm.addEventListener('submit', handleLogin);
        DOM.forgotPasswordBtn.addEventListener('click', handleForgotPassword);
        DOM.infoModalCloseBtn.addEventListener('click', () => DOM.infoModal.classList.add('hidden'));
        DOM.logoutBtn.addEventListener('click', handleLogout);
        DOM.backupBtn.addEventListener('click', handleBackup);
        DOM.restoreFileInput.addEventListener('change', handleRestore);
        DOM.addOrderBtn.addEventListener('click', () => {
            resetForm();
            DOM.orderModal.classList.remove('hidden');
        });
        DOM.cancelBtn.addEventListener('click', () => DOM.orderModal.classList.add('hidden'));
        DOM.addPartBtn.addEventListener('click', () => addPart());
        DOM.orderForm.addEventListener('submit', saveOrder);
        DOM.downPayment.addEventListener('input', updateFinancials);

        DOM.ordersList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            const order = allOrders.find(o => o.id === id);
            if (!order) return;
            
            if (btn.classList.contains('edit-btn')) editOrder(order);
            if (btn.classList.contains('replicate-btn')) replicateOrder(order.id);
            if (btn.classList.contains('delete-btn')) deleteOrder(id);
            if (btn.classList.contains('view-btn')) viewOrder(id);
        });

        DOM.toggleViewBtn.addEventListener('click', () => {
            currentOrdersView = currentOrdersView === 'pending' ? 'delivered' : 'pending';
            DOM.toggleViewBtn.textContent = currentOrdersView === 'pending' ? 'Ver Entregues' : 'Ver Pendentes';
            renderOrders();
        });

        DOM.viewModal.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            if (btn.id === 'closeViewBtn') {
                DOM.viewModal.classList.add('hidden');
                DOM.viewModal.innerHTML = '';
            }
            if (btn.id === 'comprehensivePdfBtn') {
                generateComprehensivePdf(btn.dataset.id, btn.dataset.name);
            }
        });

        DOM.financeDashboardBtn.addEventListener('click', () => {
            currentDashboardView = currentDashboardView === 'orders' ? 'finance' : 'orders';
            const isOrders = currentDashboardView === 'orders';
            
            DOM.ordersDashboard.classList.toggle('hidden', !isOrders);
            DOM.financeDashboard.classList.toggle('hidden', isOrders);
            
            if (!isOrders) renderFinanceDashboard();
        });

        DOM.userMenuBtn.addEventListener('click', () => DOM.userDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (DOM.userMenuBtn && !DOM.userMenuBtn.parentElement.contains(e.target) && !DOM.userDropdown.classList.contains('hidden')) {
                DOM.userDropdown.classList.add('hidden');
            }
        });
        
        DOM.addIncomeBtn.addEventListener('click', () => {
            DOM.transactionForm.reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionType').value = 'income';
            document.getElementById('transactionModalTitle').textContent = 'Nova Entrada';
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionStatusContainer').classList.remove('hidden');
            document.querySelector('input[name="transactionStatus"][value="pago"]').checked = true;
            DOM.transactionModal.classList.remove('hidden');
        });

        DOM.addExpenseBtn.addEventListener('click', () => {
            DOM.transactionForm.reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('transactionModalTitle').textContent = 'Nova Despesa';
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionStatusContainer').classList.add('hidden');
            DOM.transactionModal.classList.remove('hidden');
        });

        DOM.cancelTransactionBtn.addEventListener('click', () => {
            DOM.transactionForm.reset();
            DOM.transactionModal.classList.add('hidden');
        });
        
        DOM.transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveTransaction();
        });
        
        DOM.periodFilter.addEventListener('change', () => {
            if (DOM.periodFilter.value === 'custom') {
                DOM.customPeriodContainer.classList.remove('hidden');
            } else {
                DOM.customPeriodContainer.classList.add('hidden');
            }
            renderFinanceDashboard();
        });
        DOM.startDateInput.addEventListener('change', renderFinanceDashboard);
        DOM.endDateInput.addEventListener('change', renderFinanceDashboard);
        DOM.copyReportBtn.addEventListener('click', copyTransactionsToClipboard);
        
        DOM.transactionsList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('edit-transaction-btn')) {
                editTransaction(id);
            }
            if (btn.classList.contains('delete-transaction-btn')) {
                deleteTransaction(id);
            }
            if (btn.classList.contains('mark-as-paid-btn')) {
                markTransactionAsPaid(id);
            }
        });
        
        DOM.stayLoggedInBtn.addEventListener('click', resetIdleTimer);
        ['mousemove', 'keydown', 'click', 'scroll'].forEach(event => window.addEventListener(event, resetIdleTimer));
        DOM.addOptionBtn.addEventListener('click', addOption);
        DOM.closeOptionsModalBtn.addEventListener('click', () => DOM.optionsModal.classList.add('hidden'));
        DOM.optionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-option-btn')) {
                deleteOption(e.target.dataset.index);
            }
        });
        
        DOM.backupNowBtn.addEventListener('click', () => {
            handleBackup();
            DOM.backupReminderBanner.classList.add('hidden');
        });

        DOM.dismissBackupReminderBtn.addEventListener('click', () => {
            DOM.backupReminderBanner.classList.add('hidden');
        });

        document.getElementById('existingFilesContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-mockup-btn')) {
                e.target.parentElement.remove();
            }
        });

        DOM.transactionSearchInput.addEventListener('input', renderFinanceDashboard);

        DOM.priceTableBtn.addEventListener('click', () => {
            renderPriceTable('view');
            DOM.priceTableModal.classList.remove('hidden');
        });
        DOM.closePriceTableBtn.addEventListener('click', () => DOM.priceTableModal.classList.add('hidden'));
        DOM.editPriceTableBtn.addEventListener('click', () => renderPriceTable('edit'));
        DOM.cancelPriceTableBtn.addEventListener('click', () => renderPriceTable('view'));
        DOM.savePriceTableBtn.addEventListener('click', savePriceTable);
        DOM.addPriceItemBtn.addEventListener('click', () => {
            const newId = `new-${Date.now()}`;
            const newItem = { id: newId, name: '', description: '', price: 0 };
            const newRow = createPriceTableRow(newItem, 'edit');
            DOM.priceTableContainer.querySelector('#priceTableBody').appendChild(newRow);
        });
        DOM.priceTableContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-price-item-btn');
            if (deleteBtn) {
                const row = deleteBtn.closest('tr');
                const id = row.dataset.id;
                if (id.startsWith('new-')) {
                    row.remove();
                } else {
                    showConfirmModal("Tem certeza que deseja excluir este item? Esta ação será permanente.", "Excluir", "Cancelar")
                    .then(confirmed => {
                        if(confirmed) {
                           deleteDoc(doc(pricingCollection, id));
                        }
                    });
                }
            }
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (!DOM.confirmModal.classList.contains('hidden')) {
                    DOM.confirmCancelBtn.click();
                } else if (!DOM.viewModal.classList.contains('hidden')) {
                    document.getElementById('closeViewBtn')?.click();
                } else if (!DOM.orderModal.classList.contains('hidden')) {
                    DOM.cancelBtn.click();
                } else if (!DOM.priceTableModal.classList.contains('hidden')) {
                    if (!DOM.cancelPriceTableBtn.classList.contains('hidden')) {
                        DOM.cancelPriceTableBtn.click();
                    } else {
                        DOM.closePriceTableBtn.click();
                    }
                } else if (!DOM.transactionModal.classList.contains('hidden')) {
                    DOM.cancelTransactionBtn.click();
                } else if (!DOM.optionsModal.classList.contains('hidden')) {
                    DOM.closeOptionsModalBtn.click();
                } else if (!DOM.infoModal.classList.contains('hidden')) {
                    DOM.infoModalCloseBtn.click();
                }
            }
        });

    </script>
</body>
</html>
